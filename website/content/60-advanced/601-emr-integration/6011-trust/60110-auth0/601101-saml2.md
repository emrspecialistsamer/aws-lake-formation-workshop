+++
title = "Enable SAML2"
chapter = true
weight = 601101
autoNav = true
+++

<center><h3>Enable SAML2</h3></center>

<div style="text-align: justify">

   
   <br/><br/>
   
   <ol>
   
    <li>Log in to the Auth0 account. <br/>Select Users & Roles on left navigation menu and select Users and click on <b>CREATE USER</b> button. </li>
    <img src="/images/auth0-createuser.png" title="Create application" style="margin:15px 0px; border:1px solid black"/>
    <li>Create a new user with email as <b>lf-emr-developer@somecompany.com</b> and enter Password and click on <b> CREATE </b> button. This is the user we will use to authenticate and authorize AWS Lake Formation tables and columns for fine grain access.</li>
    <img src="/images/auth0-enteruserdetails.png" title="Create application" style="margin:15px 0px; border:1px solid black"/>
    <li>Create a new Application and enter "AWS SSO" for Name and Select Regular Web Application as application type and click on Create Button
    
    <img src="/images/auth2.png" title="Create application" style="margin:15px 0px; border:1px solid black"/>
    <img src="/images/auth3.png" title="Create application" style="margin:15px 0px; border:1px solid black"/>
    
    </li>
    <li>After creating the application, On the Addons tab enable SAML2 WEB APP </li>
    <img src="/images/auth4.png" title="Addon: SAML2 Web App" style="margin:15px 0px; border:1px solid black"/> 
     
    <li>Once the SAML2 WEB APP is enabled, in the pop-up window, copy and paste the below URL in the Application Callback URL text box. Later in the exercise, you will replace the <b>public-dns</b> with the actual EMR Master Node’s DNS address.</li> 
    <br/><br/>
        
    <b>https://<b>public-dns</b>:8442/gateway/knoxsso/api/v1/websso?pac4jCallback=true&client_name=SAML2Client </b>
    <br/><br/>
    and  paste the following SAML configuration code into Settings:
    <br/><br/>
    
    <pre>
    {
    "audience": "urn:amazon:webservices",
           "mappings": {
             "email": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress",
             "name": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"
           },
           "createUpnClaim": false,
           "passthroughClaimsWithNoMapping": false,
           "mapUnknownClaimsAsIs": false,
           "mapIdentities": false,
           "nameIdentifierFormat": "urn:oasis:names:tc:SAML:2.0:nameid-format:persistent",
           "nameIdentifierProbes": [
             "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"
           ]
     }
    </pre>
    
   
   <img src="/images/auth0-Addon.png" title="Addon: SAML2 Web App" style="margin:15px 0px; border:1px solid black"/>
   <br/>
   Scroll to the bottom and click <b>Enable</b>.
   <br/> <br/>
   <li> On the same UI, click on the <b>Usage</b> tab and Download Identity Provider Metadata. You'll need to configure Auth0 as the Identity Provider (IdP) for AWS, which requires you to provide an appropriate metadata to AWS. You can obtain a file containing this information by clicking Identity Provider Metadata Download link. Keep this in your local computer, also we will upload this metadata file into S3 bucket later. </li> 
   <img src="/images/auth0-metadatadownload.png" title="Addon: SAML2 Web App Usage" style="margin:15px 0px; border:1px solid black"/>
   
   
  <li>We will map AWS role <a href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-lf-iam-role.html">The IAM Role for Lake Formation</a> to a Auth0 user by creating a rule (These AWS Roles will be created part of CloudFormation Stack).</li>
   <br/>
   To create Rule, select Rules on left navigation on your Auth0 Account, select Empty rule and enter following function definition and name the rule as <b>"LF-Rule"</b> and save the changes.
   
   <br/><br/>
   Replace the <b>account-id</b> with the AWS Account Id
   
   <br/><br/>
   
   <pre>
   
   function (user, context, callback) {
         user.awsRole = 'arn:aws:iam::account-id:role/LF-SAML-Role,arn:aws:iam::account-id:saml-provider/auth0SAMLProvider';
         // the username must not contain "@" - as it is not a valid Linux username
         user.glueUser = user.name.replace(/@.*/, ''); 
        
       context.samlConfiguration.mappings = {
           'https://aws.amazon.com/SAML/Attributes/Role': 'awsRole',
           'https://aws.amazon.com/SAML/Attributes/RoleSessionName': 'glueUser',
           'https://lakeformation.amazon.com/SAML/Attributes/Username': 'glueUser'
        };
        
       callback(null, user, context);
   }
  
  </pre>
   <img src="/images/auth0-createrule.png" title="Auth0 Create Rule" style="margin:15px 0px; border:1px solid black"/>
 
   <br/>
   </ol>
   
   <b>Reference: </b> <a href="https://auth0.com/docs/integrations/aws">AWS Integration in Auth0 </a> – This page on the Auth0 documentation website describes how to set up single sign-on (SSO) with the AWS Management Console. It also includes a JavaScript example.

 
   
</div>